<?php
/*
 * Created on Aug 7, 2013
 *
 * To change the template for this generated file go to
 * Window - Preferences - PHPeclipse - PHP - Code Templates
 */

function pickem_init() {
	
}

function pickem_menu() {
	$items = array(
		'admin/config/pickem' => array(
			'title' => 'Pickem Administration',
			'description' => 'Adjust settings for your Pickem environment',
			'position' => 'right',
			'weight' => -5,
			'page callback' => 'system_admin_menu_block_page',
			'access arguments' => array('administer pickem settings'),
			'access callback' => TRUE,
			'file' => 'system.admin.inc',
			'file path' => drupal_get_path('module', 'system'),
		),
		'admin/config/pickem/settings' => array(
			'title' => 'Pickem Settings',
			'description' => 'Configure the settings for this Pickem',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_admin_settings'),
			'access callback' => 'pickem_admin_access',
			'access arguments' => array('administer pickem settings'),
			'file' => 'pickem.admin.inc',
		),
		'admin/config/pickem/games' => array(
			'title' => 'Games Management',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_admin'),
			'access arguments' => array('administer pickem games'),
			'access callback' => 'pickem_admin_access',
			'type' => MENU_NORMAL_ITEM,   
		),
		'admin/config/pickem/games/%pickem_game/edit' => array(
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_game_edit', 4),
			'access callback' => TRUE,
			'type' => MENU_CALLBACK,
		),
		'admin/structure/pickem' => array(
			'title' => 'Pickem',
			'page callback' => 'pickem_overview',
			'access callback' => TRUE,
		),
		'admin/structure/pickem/schools' => array(
			'title' => 'Schools',
			'description' => 'List of schools',
			'page callback' => 'pickem_school_list',
			'access callback' => TRUE,
			'file' => 'pickem.school.inc',
		),
		'admin/structure/pickem/games' => array(
			'title' => 'Games',
			'page callback' => 'pickem_games_listing',
			'access callback' => TRUE,
		),
	);
	$result = db_query('SELECT DISTINCT week FROM {game} WHERE season = :season ORDER BY week', array(':season' => variable_get('pickem.current_season')));
	foreach($result as $week) {
		$items['admin/structure/pickem/games/' . $week->week] = array(
			'title' => 'Week ' . $week->week,
			'page callback' => 'pickem_games_listing',
			'access callback' => TRUE,
		);
	}
	return $items;
}

function pickem_admin_access() {
	global $user;

	$arguments = func_get_args();
	$account = array_shift($arguments);
	if ($user->uid == 1) {
		return TRUE;
	}
	foreach($arguments as $permission) {
		if(!user_access($permission)) {
			return FALSE;
		}
	}
	return TRUE;
}
function pickem_games_admin($form, &$form_state, $week) {
	drupal_add_library('system', 'drupal.ajax');
	
	$query = db_select('game', 'g')->extend('PagerDefault')->extend('TableSort');
	#$query = db_select('game', 'g');
	#$query->join('game', 'g', 's.gid = g.gid');
	$query->join('school', 'host', 'g.host_school_name = host.name');
	$query->join('school', 'visiting', 'g.visiting_school_name = visiting.name');
	
	$query->fields('g', array('gid', 'host_school_name', 'host_score', 'visiting_school_name', 'visiting_score', 'game_date', 'neutral'));
	$query->addField('host', 'displaytitle', 'host_school');
	$query->addField('visiting', 'displaytitle', 'visiting_school');
	$query->orderBy('game_date')
	->condition('week', $week)
	->limit(15);
	$result = $query->execute();
	
	$rows = array();
	
	while($record = $result->fetchObject()) {
		$record->game_date_str = date('M j, Y', $record->game_date);
		$record->kickoff_time = date('g:i A', $record->game_date);
		if ($record->kickoff_time == '12:00 AM') {
			$record->kickoff_time = 'TBA';
		}
		$record->game_day = date('l', $record->game_date);

		$game_title = $record->visiting_school;
		if ($record->neutral) {
			$game_title .= ' vs ';
		} else {
			$game_title .= ' at ';
		}
		$game_title .= $record->host_school;
		$game_status = $record->complete == 'Y' ? 'F' : $record->kickoff_time;

		$rows[] = array(
			'data' => array(
				$record->game_date_str,
				$record->game_day,
				$record->host_school,
				$record->host_score,
				$record->visiting_school,
				$record->visiting_score,
				$game_status,
				'',
		);
		#kpr($record);
	}

	$headers = array(
		t('Date'),
		t('Day'),
		t('Home'),
		t('Score'),
		t('Visitor'),
		t('Score'),
		t('Status'),
		t('Options'),
	);
	
	$form['slate'] = array(
		'#theme' => 'table',
		'#header' => $headers,
		'#rows' => $rows,
	);
	$form['pager'] = array(
		'#theme' => 'pager',
	);
	return $form;
}

function pickem_permission() {
	return array(
		'administer pickem settings' => array(
			'title' => t('Administer Pickem Setttings'),
			'description' => t('Perform administration tasks on Pickem settings'),
		),
		'administer pickem games' => array(
			'title' => t('Administer Pickem Games'),
			'description' => t('Perform administration tasks on Pickem games'),
		),
	);
}
 
function pickem_block_info($delta='') {
	return array();
}

