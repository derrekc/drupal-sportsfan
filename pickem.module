<?php
/*
 * Created on Aug 7, 2013
 *
 * To change the template for this generated file go to
 * Window - Preferences - PHPeclipse - PHP - Code Templates
 */

function pickem_init() {
	
}

function pickem_menu() {
	return array(
		'admin/config/pickem' => array(
			'title' => 'Pickem Administration',
			'description' => 'Adjust settings for your Pickem environment',
			'position' => 'right',
			'weight' => -5,
			'page callback' => 'system_admin_menu_block_page',
			'access arguments' => array('administer pickem settings'),
			'access callback' => TRUE,
			'file' => 'system.admin.inc',
			'file path' => drupal_get_path('module', 'system'),
		),
		'admin/config/pickem/games' => array(
			'title' => 'Games Management',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_admin'),
			'access arguments' => array('administer pickem settings', 'administer pickem games'),
			'access callback' => TRUE,
			'type' => MENU_NORMAL_ITEM,   
		),
	);
}

function pickem_games_admin($form, &$form_state, $week) {
	$query = db_select('slate', 's');
	$query->join('game', 'g', 's.gid = g.gid');
	$query->join('school', 'host', 'g.host_school_name = host.machine_name');
	$query->join('school', 'visiting', 'g.visiting_school_name = visiting.machine_name');
	
	$query->fields('g', array('host_school_name', 'visiting_school_name', 'game_date'));
	$query->addField('host', 'title', 'host_school');
	$query->addField('visiting', 'title', 'visiting_school');
	$query->orderBy('game_date')
	->condition('slate_id', $week);
	$result = $query->execute();
	
	$rows = array();
	
	while($record = $result->fetchObject()) {
		$record->game_date_str = date('M j, Y', $record->game_date);
		$record->kickoff_time = date('g:i A', $record->game_date);
		if ($record->kickoff_time == '12:00 AM') {
			$record->kickoff_time = 'TBA';
		}
		$record->game_day = date('l', $record->game_date);

		$rows[] = array(
			'',
			$record->visiting_school,
			$record->host_school,
			$record->game_date_str,
			$record->game_day,
			$record->kickoff_time,
			'',
		);
		#kpr($record);
	}

	$headers = array('',
		array('data' => t('Visitor'), 'field' => 'visiting.title'),
		array('data' => t('Host'), 'field' => 'host.title'),
		t('Date'),
		t('Day'),
		t('Kickoff Time'),
		t('Options'),
	);
	
	$form['slate'] = array(
		'#theme' => 'table',
		'#headers' => $headers,
		'#rows' => $rows,
	);
	
	return $form;
}

function pickem_permission() {
	return array(
		'administer pickem settings' => array(
			'title' => t('Administer Pickem Setttings'),
			'description' => t('Perform administration tasks on Pickem settings'),
		),
		'administer pickem games' => array(
			'title' => t('Administer Pickem Games'),
			'description' => t('Perform administration tasks on Pickem games'),
		),
	);
}
 
function pickem_block_info($delta='') {
	return array();
}

