<?php
/*
 * Created on Aug 7, 2013
 *
 * To change the template for this generated file go to
 * Window - Preferences - PHPeclipse - PHP - Code Templates
 */

function pickem_init() {
	
}

function pickem_theme() {
	return array(
		'game_title' => array(
			'variables' => array('game' => NULL),
			'template' => 'game_title',
			'path' => drupal_get_path('module', 'pickem') . '/theme',
		),
	);
}

function pickem_menu() {
	$items = array(
		'admin/config/pickem' => array(
			'title' => 'Pickem Administration',
			'description' => 'Adjust settings for your Pickem environment',
			'position' => 'right',
			'weight' => -5,
			'page callback' => 'system_admin_menu_block_page',
			'access arguments' => array('administer pickem settings'),
			'access callback' => TRUE,
			'file' => 'system.admin.inc',
			'file path' => drupal_get_path('module', 'system'),
		),
		'admin/config/pickem/settings' => array(
			'title' => 'Pickem Settings',
			'description' => 'Configure the settings for this Pickem',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_admin_settings'),
			'access callback' => 'pickem_admin_access',
			'access arguments' => array('administer pickem settings'),
			'file' => 'pickem.admin.inc',
		),
		'admin/config/pickem/games' => array(
			'title' => 'Games Management',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_admin'),
			'access arguments' => array('administer pickem games'),
			'access callback' => 'pickem_admin_access',
			'type' => MENU_NORMAL_ITEM,   
		),
		'admin/config/pickem/games/%pickem_game/edit' => array(
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_game_edit', 4),
			'access callback' => TRUE,
			'type' => MENU_CALLBACK,
		),
		'admin/structure/pickem' => array(
			'title' => 'Pickem',
			'page callback' => 'pickem_overview',
			'access callback' => TRUE,
		),
		'admin/structure/pickem/schools' => array(
			'title' => 'Schools',
			'description' => 'List of schools',
			'page callback' => 'pickem_school_list',
			'access callback' => TRUE,
			'file' => 'pickem.school.inc',
		),
		'admin/structure/pickem/games/conf' => array(
			'title' => 'Games - By Conference',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_listing', 4),
			'access callback' => 'pickem_admin_access',
			'access arguments' => array('administer pickem games'),
		),
		'admin/structure/pickem/games/week' => array(
			'title' => 'Scoreboard - By Week',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_listing'),
			'access callback' => TRUE,
		),
		'pickem/games/week' => array(
			'title' => 'Scoreboard - By Week',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_listing', 2),
			'access callback' => TRUE,
		),
		'pickem/games/conf' => array(
			'title' => 'Scoreboard - By Conference',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_listing', 2),
			'access callback' => TRUE,
		),
		'pickem/schools' => array(
			'title callback' => 'pickem_school_page_title',
			'page callback' => 'pickem_school_listing',
			'access callback' => TRUE,
			'file' => 'pickem.school.inc',
			'menu_name' => 'Main menu',
		),
		'pickem/schools/all' => array(
			'title' => 'All',
			'type' => MENU_DEFAULT_LOCAL_TASK,
			'access callback' => TRUE,
			'weight' => -10,
		),
		'pickem/slate' => array(
			'title' => 'Pick Slate',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_slate_listing'),
			'access callback' => TRUE,
		),
		'pickem/slate/all' => array(
			'title' => 'All',
			'type' => MENU_LOCAL_TASK,
			'access callback' => TRUE,
			'weight' => -10,
		),
	);	
	$result = db_query("SELECT name, title, displaytitle FROM conference WHERE name IN ('acc','sec','big10','big12','pac12','ind') order by title");
	$menu_weight = -6;
	foreach ($result as $conf) {
		$items['admin/structure/pickem/games/conf/' . $conf->name] = array(
			'title' => $conf->displaytitle,
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_listing', 4, 5),
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK,
		);
		$items['pickem/schools/'.$conf->name] = array(
			'title callback' => 'pickem_school_page_title',
			'title arguments' => array($conf->name),
			'page arguments' => array(2),
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK,
			'weight' => $menu_weight++,
		);
	}
	$result = db_query('SELECT DISTINCT week FROM {game} WHERE season = :season ORDER BY week LIMIT 14', array(':season' => variable_get('pickem.current_season')));
	foreach($result as $week) {
		$weekkey = sprintf("%2d", $week->week);
		$items['pickem/slate/'.$week->week] = array(
			'title' => $weekkey,
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_slate_listing', 2),
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK,
		);
		$items['admin/structure/pickem/games/week/' . $week->week] = array(
			'title' => $weekkey,
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_listing', 4, 5),
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK,
		);
		$items['pickem/games/week/' . $week->week] = array(
			'title' => $weekkey,
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_games_listing', 2, 3),
			'access callback' => TRUE,
			'type' => MENU_LOCAL_TASK,
		);
	}
	return $items;
}

function pickem_slate_listing_submit($form, $form_state) {
	dpm($form_state);
}

function pickem_slate_listing($form, &$form_state, $week = NULL) {
	/*
	if (!user_access('pickem player')) {
		$form['invalid'] = array(
			'#type' => 'markup',
			'#markup' => t('<p>Please register for the Pickem competition.</p>'),
		);
		return $form;
	}
	*/
	drupal_add_library('system', 'drupal.ajax');
	if ($week == NULL) {
		$week = 1;
	}
	drupal_set_title(t('Pick Slate: Week ' . $week));
	$result = pickem_fetch_slate($week);

	$clearrow = TRUE;
	while($record = $result->fetchObject()) {

		$game_title = $record->visiting_school;
		if ($record->neutral) {
			$game_title .= ' vs ';
		} else {
			$game_title .= ' at ';
		}
		$game_title .= $record->host_school;
		$record->game_title = $game_title;
		$record->host_is_favored = substr($record->betting_line, 0, 1) == 'h';

		$record->game_date_str = date('M j, Y', $record->game_date);
		$record->kickoff_time = date('g:i A', $record->game_date);
		if ($record->kickoff_time == '12:00 AM') {
			$record->kickoff_time = 'TBA';
		}
		$record->game_day = date('D', $record->game_date);

		$pickIsOpen = TRUE;
		
		$pickOptions = '';
		if ($pickIsOpen) {
			$pickOptions[''] = t('-- Select School --');
			$pickOptions[$record->host_school_name] = $record->host_school;
			$pickOptions[$record->visiting_school_name] = $record->visiting_school;
		}
		
		$form['game_' . $record->gid] = array(
			'#type' => 'container',
			'#title' => t($game_title),
			'#attributes' => array('class' => array('pickem-entry', 'span6')),
		);
		$form['game_' . $record->gid]['game-title'] = array(
			'#type' => 'markup',
			'#markup' => theme('game_title', array('game' => $record)),
		);
		if ($clearrow) {
			$form['game_' . $record->gid]['#attributes']['class'][] = 'clear-row';
		}
		$clearrow = !$clearrow;
		
		$form_state['picks'][$record->gid] = $record->pkid ? $record->pkid : NULL;
		
		$form['game_' . $record->gid]['pkid'] = array(
			'#type' => 'hidden',
			'#default_value' => $record->pkid ? $record->pkid : '',
		);
		$form['game_' . $record->gid]['pick_school_name'] = array(
			'#type' => 'select',
			'#options' => $pickOptions,
			'#title_display' => 'invisible',
			'#default_value' => $record->pkid ? $record->pick_school_name : '',
		);
	}
	$form['actions'] = array(
		'#type' => 'actions',
		'#attributes' => array('class' => array('span12', 'clear-row')),
	);
	if (user_access('pickem player')) {
		$form['actions']['submit'] = array(
			'#type' => 'submit',
			'#value' => t('Save Picks'),
			'#attributes' => array(
				'class' => array('btn')
			),
		);
	} else {
		$form['actions']['register'] = array(
			'#type' => 'markup',
			'#markup' => t('<p><strong>Please register</strong> in order to save these picks and participate in the World\'s Greatest ACC Pickem Competition.</p>'),
		);
	}
	return $form;
}

function pickem_school_page_title($conf = NULL) {
	if ($conf != NULL) {
		$result = db_query("SELECT displaytitle FROM {conference} WHERE name = :conf", array(':conf' => $conf));
		$c = $result->fetchObject();
		return $c->displaytitle;
	} else {
		return 'Schools';
	}
}

function pickem_admin_access() {
	global $user;

	$arguments = func_get_args();
	$account = array_shift($arguments);
	if ($user->uid == 1) {
		return TRUE;
	}
	foreach($arguments as $permission) {
		if(!user_access($permission)) {
			return FALSE;
		}
	}
	return TRUE;
}

/**
 * Fetch the slate of games for a pickem week
 */
function pickem_fetch_slate($week = NULL) {
	global $user;
	
	$query = db_select('slate', 's')->extend('PagerDefault')->extend('TableSort');
	$query->join('game', 'g', 's.gid = g.gid');
	$query->leftJoin('pick', 'p', 'p.gid = g.gid and p.uid = :uid', array(':uid' => $user->uid));
	$query->join('school', 'host', 'g.host_school_name = host.name');
	$query->join('school', 'visiting', 'g.visiting_school_name = visiting.name');
	$query->leftJoin('school', 'winning', 'g.winning_school_name = winning.name');
	$query->leftJoin('school', 'userpick', 'p.pick_school_name = userpick.name');
	
	$query->fields('g');
	$query->addField('p', 'pick_school_name', 'pick_school_name');
	$query->addField('host', 'displaytitle', 'host_school');
	$query->addField('visiting', 'displaytitle', 'visiting_school');
	$query->addField('winning', 'displaytitle', 'winning_school');
	$query->addField('p', 'pkid');
	$query->orderBy('g.game_date');
	
	$query->condition('s.slate_id', $week);
	$result = $query->execute();
	return $result;
}

function pickem_fetch_games($week, $conf, $include_slate = TRUE) {
	$query = db_select('game', 'g')->extend('PagerDefault')->extend('TableSort');
	
	if ($include_slate) {
		# tip from https://drupal.org/node/1253688#comment-4882652
		$subquery = db_select('slate', 'sl');
		$subquery->addField('sl', 'slate_id', 'slate_id');
		$subquery->addField('sl', 'gid', 'slate_gid');

		if ($week != NULL) {
			$subquery->condition('slate_id', $week);
		}
		$query->leftJoin($subquery, 'sl', 'g.gid = sl.slate_gid');
		$query->addField('sl', 'slate_id', 'slate_id');
		$query->addField('sl', 'slate_gid', 'slate_game_id');
	}

	$query->join('school', 'host', 'g.host_school_name = host.name');
	$query->join('school', 'visiting', 'g.visiting_school_name = visiting.name');
	
	$query->fields('g');
	$query->addField('host', 'displaytitle', 'host_school');
	$query->addField('visiting', 'displaytitle', 'visiting_school');
	$query->orderBy('game_date');
	
	if ($week != NULL) {
		$query->condition('week', $week);
	}
	if ($conf != NULL) {
		$or = db_or();
		$or->condition('host_conf_name', $conf);
		$or->condition('visiting_conf_name', $conf);
		$query->condition($or);
	}

	$query->limit(15);
	$result = $query->execute();
	
	return $result;
}

function pickem_games_listing($form, &$form_state, $objtype = NULL, $objval = NULL) {
	drupal_add_library('system', 'drupal.ajax');
	
	if ($objtype == 'week') {
		$objval = ($objval == NULL) ? 1 : $objval;
	} else if ($objtype == 'conf') {
		$objval = ($objval == NULL) ? variable_get('pickem.default_conference') : $objval;
	}
	
	$result = NULL;
	if ($objtype == 'week') {
		$result = pickem_fetch_games($objval, NULL);
	} else if ($objtype == 'conf') {
		$result = pickem_fetch_games(NULL, $objval);
	}	

	$headers = array(
		t('Date'),
		t('Day'),
		t('Home'),
		t('Score'),
		t('Visitor'),
		t('Score'),
		t('Status'),
		t('Location'),
	);
	if (path_is_admin(current_path())) {
		$headers[] = t('Options');
	}
	
	$rows = array();
	
	while($record = $result->fetchObject()) {
		$record->game_date_str = date('M j, Y', $record->game_date);
		$record->kickoff_time = date('g:i A', $record->game_date);
		if ($record->kickoff_time == '12:00 AM') {
			$record->kickoff_time = 'TBA';
		}
		$record->game_day = date('D', $record->game_date);

		$game_title = $record->visiting_school;
		if ($record->neutral) {
			$game_title .= ' vs ';
		} else {
			$game_title .= ' at ';
		}
		$game_title .= $record->host_school;
		$game_status = $record->completed == 'Y' ? 'F' : $record->kickoff_time;
		$record->host_score = $record->host_score == '' ? '-' : $record->host_score;
		$record->visiting_score = $record->visiting_score == '' ? '-' : $record->visiting_score;
	
		$game_classes = array();
		if ($record->completed == 'Y') {
			$game_classes[] = 'game-complete';
		}

		$row = array(
			'data' => array(
				$record->game_date_str,
				$record->game_day,
				$record->host_school,
				$record->host_score,
				$record->visiting_school,
				$record->visiting_score,
				$game_status,
				$record->location,
			),
			'classes' => $game_classes,
		);
		if (path_is_admin(current_path())) {
			$row['data'][] = $record->slate_game_id ? 'Remove from Slate' : 'Add To Slate';
		}
		$rows[] = $row;
		#kpr($record);
	}
	
	$form['slate'] = array(
		'#theme' => 'table',
		'#header' => $headers,
		'#rows' => $rows,
	);
	$form['pager'] = array(
		'#theme' => 'pager',
	);
	return $form;
}

function pickem_permission() {
	return array(
		'administer pickem settings' => array(
			'title' => t('Administer Pickem Setttings'),
			'description' => t('Perform administration tasks on Pickem settings'),
		),
		'administer pickem games' => array(
			'title' => t('Administer Pickem Games'),
			'description' => t('Perform administration tasks on Pickem games'),
		),
		'pickem player' => array(
			'description' => t('Can play the pickem content(s)'),
		),
	);
}
 
function pickem_block_info($delta='') {
	return array();
}

function pickem_load_conferences($p5 = TRUE) {
	$query = db_select('conference', 's')->extend('PagerDefault')->extend('TableSort');
	$query->fields('s');
	if ($p5) {
		$query->condition('name', array('acc','big10','big12','pac12','sec','ind'), 'IN');
	}
	$result = $query->execute();
	$rows = array();
	while ($c = $result->fetchObject()) {
		$rows[] = $c;
	}
	return $rows;
}		

function pickem_load_weeks() {
}