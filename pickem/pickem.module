<?php
/*
 * Created on Aug 7, 2013
 *
 * To change the template for this generated file go to
 * Window - Preferences - PHPeclipse - PHP - Code Templates
 */

require_once(drupal_get_path('module', 'pickem') . '/pickem.model.inc');

function pickem_init() {
	$now = time();
}

function pickem_menu() {
	$_current_season = variable_get('pickem.current_season');
	
	$items = array(
		# ============ ADMIN PATHS =============
		'admin/structure/pickem' => array(
			'title' => 'Pickem',
			'description' => 'Pickem Management',
			'access arguments' => array('administer pickem entities'),
		),
		'admin/structure/pickem/weekly-pickem' => array(
			'title' => 'Weekly Pickem',
			'access arguments' => array('administer pickem entities'),
		),
		'admin/structure/pickem/daily-pickem' => array(
			'title' => 'Daily Pickem',
			'description' => 'Pickem Management',
			'access arguments' => array('administer pickem entities'),
		),
		'admin/content/pickem/manage/%pickem/players' => array(
			'title' => 'Manage Players',
			'description' => 'Add and manage playes for this pickem',
			'access arguments' => array('administer pickem entities'),
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_admin_players_form', 4),
			'file' => 'includes/pickem.admin.inc',
			'type' => MENU_LOCAL_TASK,
		),
		'admin/content/pickem/manage/%pickem/players/add/%' => array(
			'title' => 'Manage Players',
			'description' => 'Add and manage playes for this pickem',
			'access arguments' => array('administer pickem entities'),
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_admin_players_form', 4),
			'file' => 'includes/pickem.admin.inc',
			'type' => MENU_LOCAL_TASK,
		),
		# ============ FRONT END PATHS =============
		'pickem' => array(
			'title' => 'Sports Pickem Portal',
			'page callback' => 'pickem_home',
			'access callback' => TRUE,
		),
		'playerform' => array(
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_pickem_player_form'),
			'file' => 'pickem.form.inc',
			'access callback' => 'pickem_player_access',
			'title' => 'Player Form',
		),
		'request-pickem' => array(
			'title' => 'Request Pickem',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_request_new_pickem'),
			'access callback' => 'pickem_user_access',
			'access arguments' => array('authenticated user'),
			'file' => 'pickem.form.inc',
		),
		'pickem/%pickem/join' => array(
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_pickem_user_join_form', 1),
			'access callback' => TRUE,
		),
		'pickem/%pickem/slate' => array(
			'page callback' => 'pickem_pickem_slate',
			'page arguments' => array(1),
			'file' => 'pickem.pages.inc',
			'access callback' => 'pickem_user_access',
			'access arguments' => array('authenticated user'),
			'title' => 'Pickem Slate',
		),
		'pickem/%pickem/slate/%' => array(
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_pickem_slate_form', 1, 3),
			'file' => 'pickem.pages.inc',
			'access callback' => 'pickem_user_access',
			'access arguments' => array('authenticated user'),
			'title' => 'Make Your Picks',
		),
		'pickem/%pickem/provision-slate' => array(
			'page callback' => 'pickem_pickem_provision_slate',
			'page arguments' => array(1),
			'file' => 'pickem.pages.inc',
			'access callback' => 'pickem_user_access',
			'access arguments' => array('authenticated user'),
		),
		#'user/%user/pickem-settings' => array(
		#	'title' => 'Pickem Settings',
		#	'page callback' => 'drupal_get_form',
		#	'page arguments' => array('pickem_user_pickem_settings_form', 1),
		#	'access callback' => 'pickem_user_access',
		#	'access arguments' => array('authenticated user'),
		#	'type' => MENU_LOCAL_TASK,
		#),
		'game/%/%/%/%' => array(
			'page callback' => 'game_info_page',
			'page arguments' => array(1, 2, 3, 4),
			'access callback' => TRUE,
			'file' => 'pickem.pages.game.inc',
		),
		
		# ============= ADMIN UTILITY PATHS =============
		'pickem/clear-session' => array(
			'page callback' => 'pickem_clear_pickem_session_data',
			'page arguments' => array(2,3),
			'file' => 'pickem.util.inc',
			'access callback' => 'pickem_user_access',
			'access arguments' => array('administer pickem settings'),
		),
	);
	
	#$items = array_merge($items, _pickem_pickem_paths($items));
	
	return $items;
}

function pickem_entity_info() {
	return array(
		'pickem' => array(
			'label' => t('Pickem'),
			'label callback' => 'pickem_label_callback',
			'plural label' => t('Pickems'),
			'entity class' => 'Pickem',
			'controller class' => 'PickemAPIController',
			'base table' => 'pickem',
			'fieldable' => TRUE,
			'entity keys' => array(
				'id' => 'pid',
				'bundle' => 'pickem_type',
			),
			'load hook' => 'pickem_load',
			'admin ui' => array(
				'path' => 'admin/content/pickem',
				#'controller class' => 'TeamUIController',
				'file' => 'includes/pickem.admin.inc',
			),
			'bundles' => array(
				'weekly-pickem' => array(
					'label' => 'Weekly Pickem',
					'admin' => array(
						'path' => 'admin/structure/pickem/weekly-pickem/manage',
						'access arguments' => array('administer pickem entities'),
					),
				),
				'daily-pickem' => array(
					'label' => 'Daily Pickem',
					'admin' => array(
						'path' => 'admin/structure/pickem/daily-pickem/manage',
						'access arguments' => array('administer pickem entities'),
					),
				),
			),
			'module' => 'pickem',
			'access callback' => 'pickem_access_callback',
			'static cache' => TRUE,
			'uri callback' => 'entity_class_uri',
		),
		'pickem_slate' => array(
			'label' => t('Pickem Slate'),
			'label callback' => 'pickem_slate_label_callback',
			'entity class' => 'PickemSlate',
			'plural label' => t('Pickem Slates'),
			'controller class' => 'PickemSlateController',
			'base table' => 'pickem_slate',
			'load hook' => 'pickem_slate_load',
			'fieldable' => TRUE,
			'uri callback' => 'pickem_slate_basic_uri',
			'entity keys' => array(
				'id' => 'slid',
			),
			'module' => 'pickem',
		),
		'pick' => array(
			'label' => t('Pick'),
			'label callback' => 'entity_label',
			'entity class' => 'Pick',
			'plural label' => t('Picks'),
			'controller class' => 'PickController',
			'base table' => 'pick',
			'load look' => 'pick_load',
			'fieldable' => TRUE,
			'uri callback' => 'pick_basic_uri',
			'entity keys' => array(
				'id' => 'pkid',
			),
			'module' => 'pickem',
		),
		'pickem_player' => array(
			'label' => t('Pickem Player'),
			'label callback' => 'entity_label',
			'entity class' => 'PickemPlayer',
			'plural label' => t('Pickem Player'),
			'controller class' => 'PickemPlayerController',
			'base table' => 'pickem_player',
			'load look' => 'pickem_player_load',
			'fieldable' => TRUE,
			'uri callback' => 'pickem_player_basic_uri',
			'entity keys' => array(
				'id' => 'uid',
			),
			'module' => 'pickem',
		),
	);
}

/**
 * Team access callback.
 */
function pickem_access_callback() {

  if (user_is_anonymous() || !user_access('administer pickem entities')) {
    return FALSE;
  }
  else {
    return TRUE;
  }

}

/**
 * Implements hook_entity_load
 */
function pickem_entity_load(&$entities, $type) {
	if ($type == 'user') {
		foreach ($entities as $user) {
			if (!isset($user->pickems)) {
				$pickems = pickem_player_load_multiple(array($user->uid));
				if ($pickems !== FALSE) {
					$user->pickems = array();
					foreach ($pickems as $p) {
						$user->pickems[$p->pickem_id] = TRUE;
					}
				} else {
					$user->pickems = $pickems;
				}
			}
		}
	}
	foreach ($entities as $entity) {
		$entity->foo = $type;
	}
}
  
function pickem_theme($existing, $type, $theme, $path) {
	return array(
		'pickem_home' => array(
			'template' => 'pickem_home',
			'variables' => array('pickem_content' => NULL, 'user_is_logged_in' => FALSE),
		),
		'pickem_picks' => array(
			'template' => 'pickem_picks',
			'variables' => array('entries' => NULL),
		),
		'game_title' => array(
			'variables' => array('game' => NULL, 'logobasepath' => NULL, 'other_player' => NULL),
			'template' => 'game_title',
			'path' => drupal_get_path('module', 'pickem') . '/theme',
		),
		#'slate_form' => array(
		#	'render element' => 'form',
		#	//'template' => 'form--game-slate',
		#	'file' => 'pickem.admin.inc',
		#),
		#'admin_scoreboard' => array(
		#	'render element' => 'form',
		#	'file' => 'pickem.admin.inc',
		#),
		'slate_overview' => array(
			'variables' => array('slate' => NULL),
		),
		'pickem-overview' => array(
			'variables' => array(
				'standingsTopTen' => NULL,
				'upcomingGames' => NULL,
				'pickemPlayer' => NULL,
				'pickem' => NULL,
			),
			'template' => 'pickem-overview',
		),
		'pickem_pickem_player_form' => array(
			'render element' => 'form',
			'file' => 'pickem.form.inc',
		),
		'pickem_pickem__slate_form' => array(
			'render element' => 'form',
			'template' => 'pickem_slate_form',
		),
		'slate-game' => array(
			'render element' => 'slate_event',
			'template' => 'slate_game',
		),
		'slate-sportsevent' => array(
			'render element' => 'slate_event',
			'template' => 'slate_sportsevent',
		),
		'slate-tourney' => array(
			'render element' => 'slate_event',
			'template' => 'slate_tourney',
		),
		'slate-series' => array(
			'render element' => 'slate_event',
			'template' => 'slate_series',
		),
		'pickem-form-notes' => array(
			'template' => 'pickem_form_notes',
			'variables' => array(),
		),
		'modal-provisioning-needed' => array(
			'template' => 'provisioning-needed',
			'variables' => array('pick_default' => NULL),
		),
		'active-pickems' => array(
			'template' => 'active_pickems',
			'variables' => array('pickems' => NULL),
		),
		'slate_compare' => array(
			'variables' => array('slate' => NULL, 'slate_compare' => NULL, 'games' => NULL, 'player_name' => NULL, 'compare_player' => NULL, 'week' => NULL),
		)
	);
}

/** 
 * Implements hook_action_info()
 */
function pickem_action_info() {
	return array(
		'pickem_user_register_action' => array(
			'type' => 'user',
			'label' => t('Provision Pickem player on initial login'),
			'configurable' => FALSE,
			'triggers' => array('user_insert'),
		),
	); 
}

function pickem_form_alter(&$form, &$form_state, $form_id) {
	if ($form_id == 'pickem_slate_form') {
		$form['#theme'] = array('slate_form');
	}
	if ($form_id == 'pickem_admin_week_games') {
		$form['#theme'] = array('admin_scoreboard');
	}
}

function _pickem_pickem_paths() {
	$items = array();
	
	$dbResult = db_select('pickem','p')
		->fields('p')
		->execute();
		
	foreach ($dbResult as $row) {
		$overviewkey = sprintf('pickem/%pickem', $row->pid);
		$standingskey = sprintf('pickem/%pickem/standings', $row->pid);
		$adminKey = sprintf('admin/pickem/%s', $row->pid);
		$slatekey = sprintf('pickem/%pickem/slate', $row->pid);
		$joinKey = sprintf('pickem/join/%pickem', $row->pid);
		$playersetupKey = sprintf('pickem/%pickem/player-setup', $row->pid);
		$provisionSlateKey = sprintf('pickem/%pickem/provision-slate', $row->pid);
		
		/*
		$items[$adminKey] = array(
			'page callback' => 'drupal_get_form',
			'page arguments' => array('pickem_admin_pickem_form', $row->name),
			'file' => 'pickem.admin.inc',
			'access callback' => 'pickem_admin_access',
			'access arguments' => array('administer pickem settings'),
			'title' => $row->title,
		);
		*/
		if ($row->active) {
			$items[$overviewkey] = array(
				'page callback' => 'pickem_pickem_overview',
				'page arguments' => array($row->name),
				'file' => 'pickem.pages.inc',
				'access callback' => 'pickem_player_access',
				'access arguments' => array($row->pid),
				'title' => $row->title,
			);
			$items[$slatekey] = array(
				'page callback' => 'drupal_get_form',
				'page arguments' => array('pickem_pickem_slate_form', $row->name),
				'file' => 'pickem.pages.inc',
				'access callback' => 'pickem_user_access',
				'access arguments' => array(sprintf('%s player', $row->name)),
				'title' => 'Make Your Picks',
			);
			$items[$joinKey] = array(
				'page callback' => 'drupal_get_form',
				'page arguments' => array('pickem_pickem_user_join_form', 2),
				'access callback' => TRUE,
				#'access callback' => 'pickem_user_access',
				#'access arguments' => array('authenticated user'),
				'type' => MENU_CALLBACK,
			);
			$items[$playersetupKey] = array(
				'page callback' => 'drupal_get_form',
				'page arguments' => array('pickem_pickem_player_setup_form'),
				'file' => 'pickem.pages.inc',
				'access callback' => 'pickem_user_access',
				'access arguments' => array(sprintf('%s player', $row->name)),
				'title' => sprintf('Player options for %s', $row->title),
			);
			$items[$provisionSlateKey] = array(
				'page callback' => 'pickem_pickem_provision_slate',
				'page arguments' => array(3),
				'file' => 'pickem.pages.inc',
				'access callback' => 'pickem_user_access',
				'access arguments' => array(sprintf('%s player', $row->name)),
			);
			$items[$standingskey] = array(
				'page callback' => 'pickem_pickem_standings',
				'page arguments' => array($row->pid),
				'file' => 'pickem.pages.inc',
				'access callback' => 'pickem_player_access',
				'access arguments' => array($row->pid),
				'title' => 'Standings',
				'type' => MENU_LOCAL_ACTION,
			);
		}
	}
	return $items;
}

function pickem_player_access($pid = NULL) {
	global $user;
	if ($user->uid == 1) {
		return TRUE;
	}
	if (user_access('administer pickem settings')) {
		return TRUE;
	}
	if ($pid == NULL) {
		return FALSE;
	}
	if (user_is_anonymous()) {
		return FALSE;
	}
	$res = db_select('pickem_player', 'pp')
		->fields('pp')
		->condition('pp.pickem_id', $pid)
		->condition('pp.uid', $user->uid)
		->execute();
	$player = $res->fetchObject();
	
	return user_access('pickem player') && !is_null($player);
}

function pickem_user_access() {
	global $user;
	$arguments = func_get_args();

	if ($user->uid == 1) {
		return TRUE;
	}
	
	foreach($arguments as $role) {
		if (in_array($role, $user->roles)) {
			return TRUE;
		}
	}
	
	foreach($arguments as $permission) {
		if(user_access($permission)) {
			return TRUE;
		}
	}
	return FALSE;
}

function pickem_admin_access() {
	global $user;

	$arguments = func_get_args();
	//$account = array_shift($arguments);
	if ($user->uid == 1) {
		return TRUE;
	}

	foreach($arguments as $permission) {
		if(user_access($permission)) {
			return TRUE;
		}
	}
	return FALSE;
}

function pickem_permission() {
	return array(
    'administer pickem entities' => array(
      'title' => t('Administer Pickem Entities'),
      'description' => t('Allows a user to administer pickem entities'),
    ),
    'view pickem entities' => array(
      'title' => t('View Pickem Entity'),
      'description' => t('Allows a user to view the pickem entities.'),
    ),
    'create pickem entities' => array(
      'title' => t('Create Pickem Entities'),
      'description' => t('Allows a user to create pickem entities.'),
    ),
    'edit pickem entities' => array(
      'title' => t('Edit Pickem Entities'),
      'description' => t('Allows a user to edit pickem entities.'),
    ),
    'delete pickem entities' => array(
      'title' => t('Delete Pickem Entities'),
      'description' => t('Allows a user to delete pickem entities.'),
    ),
    'use pickem bulk operations' => array(
      'title' => t('Do bulk operations on Pickem entities'),
      'description' => t('Allows a user to do bulk operations.'),
    ),
		'administer pickem settings' => array(
			'title' => t('Administer Pickem Setttings'),
			'description' => t('Perform administration tasks on Pickem settings'),
		),
		'administer pickem games' => array(
			'title' => t('Administer Pickem Games'),
			'description' => t('Perform administration tasks on Pickem games'),
		),
		'pickem player' => array(
			'title' => t('Make picks in the pickem contest'),
			'description' => t('Can play the pickem content(s)'),
		),
	);
}


/*============= ALTERED FORMS =============*/

/* ================= PAGE CALLBACKS ===================== */
function pickem_user_pickem_settings_form($form, &$form_state) {
	global $user;
	$form['#parents'] = array();
	
	$dbres = db_select('pickem', 'p')
		->fields('p', array('name', 'title'))
		->condition('active', '1')
		->execute();
	foreach ($dbres as $r) {
		$key = sprintf('%s_user_default_pick', $r->name);
		$field = field_info_field($key);
		$instance = field_info_instance('user', $key, 'pickem');
		$items = field_get_items('user', $user, $key);
		
		$form[$r->name] = array(
			'#type' => 'fieldset',
			'#title' => t($r->title),
			'#collapsible' => TRUE,
			'#collapsed' => FALSE,
			'#tree' => TRUE,
		);
		$form[$r->name][$key] = field_default_form('user', $user, $field, $instance, LANGUAGE_NONE, $items, $form, $form_state);
	}	
	$form['actions'] = array(
		'#type' => 'actions',
	);
	$form['actions']['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Save Changes'),
	);
	return $form;
}

/**
 * Implements hook_sportsevent_insert
 */
#function pickem_sportsevent_insert($sportsevent) {
#	// load all pickems then add pickem_slate entries based on 
#	// the 'sport' value and 'conf_name' or team_name
#	$pickems = pickem_load_multiple();
#	foreach ($pickems as $pickem) {
#		
#	}
#}

/**
 * Page Callback for Pickem Home Page
 */
function pickem_home() {
	//if (!pickem_user_access('authenticated user')) {
	//	drupal_goto('node');
	//	return;
	//}
	global $user;
	$pickem_player = pickem_player_load_multiple(array($user->uid));
	
	$user_is_logged_in = user_is_logged_in();
	$page = array();

	$pickem_content = array();
	$pickems = pickem_load_multiple();
	

	# determin the actions that are presented with each Pickem record
	foreach ($pickems as $pid => $pickem) {
		$pickem_player = $pickem->getPlayer($user->uid);
		
		$lookup = sprintf('%s player', $pickems[$pid]->name);
		$lookup_manager = sprintf('%s manager', $pickems[$pid]->name);
		$pickems[$pid]->ui_actions = array();
		
		// Show appropriate action buttons when 
		// user is logged in
		if ($user_is_logged_in) {
			$user_can_play = !empty($pickem_player);
			$user_can_manage = in_array('administer pickem settings', $user->roles) || in_array('administrator', $user->roles);
			if ($user_can_play) {
				$pickems[$pid]->ui_actions[] = array(
					'#type' => 'markup',
					'#markup' => l(t('Overview/Standings'), sprintf('pickem/%s', $pickems[$pid]->pid), 
						array(
							'attributes' => array('class' => array('btn', 'btn-primary'))
						)
					),
				);
				$pickems[$pid]->ui_actions[] = array(
					'#type' => 'markup',
					'#markup' => l(t('Play / Make Picks'), sprintf('pickem/%s/slate', $pickems[$pid]->pid), 
						array(
							'attributes' => array('class' => array('btn', 'btn-default'))
						)
					),
				);
			}
			else {
				$pickems[$pid]->ui_actions[] = array(
					'#type' => 'markup',
					'#markup' => l(t('Join This Pickem'), sprintf('pickem/%s/join', $pickems[$pid]->pid), 
						array(
							'attributes' => array('class' => array('btn', 'btn-default'))
						)
					),
				);
			}
			if ($user_can_manage) {
				$pickems[$pid]->ui_actions[] = array(
					'#type' => 'markup',
					'#markup' => l(t('Manage'), sprintf('pickem/%s/manage', $pickems[$pid]->pid), 
						array(
							'attributes' => array('class' => array('btn', 'btn-info'))
						)
					),
				);
			}
		}
	}

	$pickem_content['active_pickems'] = 
		theme('active-pickems', 
			array('pickems' => $pickems)
		);
	
	$page['pickem_home'] = array(
		'#theme' => 'pickem_home',
		'#pickem_content' => $pickem_content,
		'#user_is_logged_in' => $user_is_logged_in,
	);
	return $page;
	#return theme('pickem_home', array('pickem_content' => $pickem_content));
}

/**
 * Page callback for user join request
 */
function pickem_pickem_user_join_form($form, &$form_state, $pickem) {
	global $user;

	$player = $pickem->getPlayer($user->uid);
	$form['#parents'] = array();
	
	drupal_set_title(sprintf('Join %s', $pickem->title));
	
	// if applicable, show the rules to the user
	// using taxonomy where a node is retrieved using term = <$pname> and term = rules
	$pname_term = taxonomy_get_term_by_name($pickem->name);
	$rules_term = taxonomy_get_term_by_name('rules');
	if (count($pname_term)) {
		$pname_term = array_shift($pname_term);
	}
	
	$node_ids = taxonomy_select_nodes($pname_term->tid);
	if (count($node_ids)) {		
		$node = node_load($node_ids[0]);
		$form['rules'] = array(
			'#type' => 'markup',
			'#markup' => 	$node->body['und'][0]['safe_value'],
		);
	}

	$already_joined = !empty($player) || in_array('administrator', $user->roles); 
	
	if ($already_joined) {
		$path = sprintf('pickem/%s/slate', $pickem->pid);
		drupal_goto($path);
		return;
	}
	
	// load user option(s)
	if (!$already_joined) {
		$field_key = sprintf('%s_user_default_pick', $pickem->name);
		$field = field_info_field($field_key);
		if ($field) {
			$instance = field_info_instance('user', $field_key, 'user');
			$items = field_get_items('user', $user, $field_key);
			$form['default_pick'] = field_default_form('user', $user, $field, $instance, LANGUAGE_NONE, $items, $form, $form_state);
			//$form['default_pick'][$field_key]['und'][0]['value']['#required'] = TRUE;
			$form['default_pick'][$field_key]['und']['#required'] = TRUE;
			$form['default_pick'][$field_key]['#required'] = TRUE;
		}
	}
	
	$form_state['pickem'] = $pickem;
	$pname = $pickem->name;
		
	$form['actions'] = array('#type' => 'actions');
	if ($already_joined) {
		$form['actions']['already_joined'] = array(
			'#type' => 'markup',
			'#markup' => l(t('Make Picks'), 'pickem/' . $pickem->pid . '/slate', 
					array('attributes' => array('class' => array('btn', 'btn-primary')))),
			'#suffix' => '&nbsp;',
		);
	}
	$form['actions']['accept'] = array(
		'#type' => 'submit',
		'#value' => $already_joined ? t('You already joined') : t('Join'),
		'#attributes' => array(
			'class' => array('btn', 'btn-info')
		),
		'#disabled' => $already_joined,
	);
	return $form;
}

function pickem_pickem_user_join_form_submit($form, &$form_state) {
	global $user;
	$values = $form_state['values'];
	$pickem = $form_state['pickem'];
	
	if ($values['op'] == 'Join') {
		$controller = entity_get_controller('pickem');
		$controller->addPlayer($user->uid, $pickem->pid);

		drupal_set_message(t('You have been added to :pickem', array(':pickem' => $pickem->title)));
		
		#$role = user_role_load_by_name(sprintf('%s player', $pickem->name));
		#dpm(array($role, sprintf('%s player', $pickem->name)));
		#user_multiple_role_edit(array($user->uid), 'add_role', $role->rid);
		
		// save any field data specific to this user (player)
		#$edit = (array) $user;
		#$field_key = sprintf('%s_user_default_pick', $pickem->name);
		#$edit[$field_key]['und'][0]['value'] = $values[$field_key]['und'][0]['value'];
		#user_save($user, $edit);
		
		$form_state['redirect'] = 'pickem/' . $pickem->pid . '/slate';
	}
}

function pickem_picks($week = NULL) {
	//require_once(drupal_get_path('module', 'pickem') . '/pickem.model.picks.inc');
	$sampleData = GoogleSpreadsheetManager::sampleData();
	$schoolData = GoogleSpreadsheetManager::fetchSchoolsSpreadsheetEntries();
	dpm($schoolData);

	$page['header'] = array(
		'#type' => 'markup',
		'#markup' => '<h1>Pickem Picks</h1>',
		);
	$page['entries'] = array(
		'#theme' => 'pickem_picks',
		'#entries' => $sampleData,
		);
	return $page;
}

/**
 * Implements hook_block_view_alter()
 */
function pickem_block_view_alter(&$data, $block) {
	if ($block->module == 'system' && $block->delta == 'powered-by') {
		$data['content'] = t('Powered by The world\'s greatest college football fan.');
	}
}	


function pickem_games_listing($form, &$form_state, $objtype = NULL, $objval = NULL) {
	drupal_add_library('system', 'drupal.ajax');
	
	if ($objtype == 'week') {
		$objval = ($objval == NULL) ? 1 : $objval;
	} else if ($objtype == 'conf') {
		$objval = ($objval == NULL) ? variable_get('pickem.default_conference') : $objval;
	}
	
	$result = NULL;
	if ($objtype == 'week') {
		$result = pickem_fetch_games($objval, NULL);
	} else if ($objtype == 'conf') {
		$result = pickem_fetch_games(NULL, $objval);
	}	

	$headers = array(
		t('Date'),
		t('Day'),
		t('Home'),
		t('Score'),
		t('Visitor'),
		t('Score'),
		t('Status'),
		t('Location'),
	);
	if (path_is_admin(current_path()) || user_access('administer pickem games')) {
		$headers[] = t('Options');
	}
	
	$rows = array();
	
	while($record = $result->fetchObject()) {
		$record->game_date_str = date('M j, Y', $record->game_date);
		$record->kickoff_time = date('g:i A', $record->game_date);
		if ($record->kickoff_time == '12:00 AM') {
			$record->kickoff_time = 'TBA';
		}
		$record->game_day = date('D', $record->game_date);

		$game_title = $record->visiting_school;
		if ($record->neutral) {
			$game_title .= ' vs ';
		} else {
			$game_title .= ' at ';
		}
		$game_title .= $record->host_school;
		$game_status = $record->completed == 'Y' ? 'F' : $record->kickoff_time;
		$record->host_score = $record->host_score == '' ? '-' : $record->host_score;
		$record->visiting_score = $record->visiting_score == '' ? '-' : $record->visiting_score;
	
		$game_classes = array();
		if ($record->completed == 'Y') {
			$game_classes[] = 'game-complete';
		}

		$row = array(
			'data' => array(
				$record->game_date_str,
				$record->game_day,
				$record->host_school,
				$record->host_score,
				$record->visiting_school,
				$record->visiting_score,
				$game_status,
				$record->location,
			),
			'classes' => $game_classes,
		);
		if ($record->completed == 'N' && (path_is_admin(current_path()) || user_access('administer pickem games'))) {
			$linktext = $record->slate_game_id ? 'Remove from Slate' : 'Add To Slate';
			$linkpath = $record->slate_game_id ? 'remove' : 'add';
			$row['data'][] = array(
				'data' => array(
					'#type' => 'link',
					'#title' => t($linktext),
					'#href' => 'pickem/ajax/slate/' . $linkpath . '/' . $record->gid,
					'#ajax' => array(
						'wrapper' => 'slateCell-' . $record->gid,
						'method' => 'html',
					),
				),
				'id' => 'slateCell-' . $record->gid,
			);
			/*
			$row['data'][] = '<div id="slateCell-' . $record->gid . '">' . l(t($linktext), 'pickem/ajax/slate/' . $linkpath . '/' . $record->gid, 
				array(
					'attributes' => array(
						'class' => array('slateTrigger','use-ajax')
					)
				)
			) . '</div>';
			*/
		} else {
			$row['data'][] = '&nbsp;';
		}
		$rows[] = $row;
		#kpr($record);
	}
	
	$form['slate'] = array(
		'#theme' => 'table',
		'#header' => $headers,
		'#rows' => $rows,
		'#attributes' => array(
			'class' => array('table','table-condensed'),
		)
	);
	$form['pager'] = array(
		'#theme' => 'pager',
	);
	return $form;
}

function pickem_ajax_slate_add($gid) {
	// got a game id -- let's add the game to the slate..
	$game = pickem_load_game($gid);
	$o = new stdClass();
	$o->pid = 1;
	$o->gid = $gid;
	$o->season = $game->season;
	$o->slate_id = $game->week;
	$res = drupal_write_record('slate', $o);
	
	$commands = array();
	$msg = "Remove from Slate";
	if ($res == FALSE) {
		$commands[] = ajax_command_append('#slateCell-' . $gid, t('Unable to add to slate!'));
	} else {
		$output = array(
			'#type' => 'link',
			'#title' => t($msg),
			'#href' => 'pickem/ajax/slate/remove/' . $gid,
			'#attributes' => array('class' => array('use-ajax', 'slateTrigger')),
			'#ajax' => array(
				'wrapper' => 'slateCell-' . $gid,
				'method' => 'html',
			),
		);
		$commands[] = ajax_command_html('#slateCell-' . $gid, render($output));
	}
	// See ajax_example_advanced.inc for more details on the available commands
	// and how to use them.
	$page = array(
		'#type' => 'ajax',
		'#commands' => $commands,
	);
	ajax_deliver($page);
}

function pickem_ajax_slate_remove($gid) {
	$result = db_query('SELECT s.* FROM {slate} s WHERE gid = :gid', array(':gid' => $gid));
	$slate = $result->fetchObject();
	$game = pickem_load_game($gid);
	$default_conf_name = variable_get('pickem.default_conference');
	$protected_schools = variable_get('pickem.protected_schools');
	$commands = array();
	#if ($game->host_conf_name == $default_conf_name || 
	#		$game->visiting_conf_name == $default_conf_name) {
	if (in_array($default_conf_name, array($game->host_conf_name, $game->visiting_conf_name))) {
		$commands[] = ajax_command_alert(t("Games involving ACC schools cannot be removed from the slate."));
	} else if (in_array($game->host_school_name, $protected_schools) || 
						 in_array($game->visiting_school_name, $protected_schools)) {
		$commands[] = ajax_command_alert(t('Games involving protected schools cannot be removed from the slate.'));
	} else {
		$num_deleted = db_delete('slate')
			->condition('gid', $gid)
			->condition('pid', '1')
			->execute();

		$msg = "Add to Slate";
		$output = array(
			'#type' => 'link',
			'#title' => t($msg),
			'#href' => 'pickem/ajax/slate/add/' . $gid,
			'#attributes' => array('class' => array('use-ajax', 'slateTrigger')),
			'#ajax' => array(
				'wrapper' => 'slateCell-' . $gid,
				'method' => 'html',
			),
		);
		$commands[] = ajax_command_html('#slateCell-' . $gid, render($output));
	}
	$page = array(
		'#type' => 'ajax',
		'#commands' => $commands,
	);
	ajax_deliver($page);
}

function pickem_pick_team_name(&$form, &$form_state) {
	global $user;
	// get the object ID for this row
	$pickem = $form_state['pickem'];
	
	// target school
	$target_team_name = $form_state['clicked_button']['#team_name'];
	$pkid = $form_state['clicked_button']['#pkid'];
	$objid = $form_state['clicked_button']['#objid'];
	$objtype = $form_state['clicked_button']['#objtype'];
	$slid = $form_state['clicked_button']['#slid'];
	$team_name = $form_state['clicked_button']['#team_name'];
	
	_pickem_cache_pick($pickem, $slid, $form_state['week'], $objid, $objtype, $pkid, $target_team_name);
		
	foreach(element_children($form['events'][$objid]['slate_event']['pick_team_name']) as $tname) {
		$form['events'][$objid]['slate_event']['pick_team_name'][$tname]['#attributes']['class'] = array('btn', 'btn-sm', 'btn-block');
		if ($tname == $target_team_name) {
			$form['events'][$objid]['slate_event']['pick_team_name'][$tname]['#attributes']['class'][] = 'btn-info';
		}
		else {
			$form['events'][$objid]['slate_event']['pick_team_name'][$tname]['#attributes']['class'][] = 'btn-default';
		}
	}

	return $form['events'][$objid]['slate_event'];
}
 
function pickem_schedule_overview() {
	return t('Coming soon...');
}

function pickem_block_info($delta='') {
	return array(
		'leaderboard' => array(
			'info' => 'Pickem Standings Leaderboard',
			'cache' => DRUPAL_NO_CACHE,
		),
		'active-pickems' => array(
			'info' => 'Available Pickems',
			'cache' => DRUPAL_NO_CACHE,
		),
	);
}

/** 
 * Implements hook_block_view
 */
function pickem_block_view($delta='') {
	global $user;
	if ($delta == 'active-pickems') {
		$pickems = PickemManager::activePickems();
		return array(
			'subject' => t('Join These Pickem Contests'),
			'content' => array(
				'#theme' => 'active-pickems',
				'#pickems' => $pickems,
			),
		);
	}
	
	if ($delta != 'leaderboard') {
		return '';
	}	
	
	$week = -1;
	
	$headers = array(
		t(''),
		t('Player'),
		t('W'),
		t('L'),
		t('%'),
		t('Picks'),
	);
	$rows = array();

	$standings = pickem_load_standings(-1, 1, variable_get('pickem.current_season'));
	$top_10 = array_slice($standings, 0, 10);
	
	$current_rank = 0;
	$last_correct = NULL;
	$rank_pos = 0;
	
	foreach ($top_10 as $player) {
		$rank_pos++;
		$current_correct = $player->correct;
		
		if ($player->correct != $last_correct) {
			$current_rank = $rank_pos;
			$last_correct = $player->correct;
		}
		
		$pct = 0.0;
		if ($player->correct + $player->incorrect) {
			$pct = (float) $player->correct / ($player->correct + $player->incorrect);
		}
		$classes = array();
		$thumb = '';
		if (user_is_logged_in()) {
			$player->data = user_load($player->uid);
			//dpm($player->data);
			if ($player->player_name == $user->name) {
				$classes[] = 'info';
			}
		}
		$player_name_cell = '<span title="' . $player->uid . '">' . $player->player_name . '</span>';
		
		#if ($player->weeks_won > 0 && ($week == -1)) {
		#	$player_name_cell .= ' (' . $player->weeks_won . ')';
		#}
		#if ($week == -1) {
		#	$player_name_cell = l($player_name_cell, 'user/'.$player->uid.'/pickemresults');
		#}
		//if ($week == $_SESSION['current_week']->week) {
		//	$player_name_cell = l(t($player->player_name), 'pickem/slate/' . $player->uid);
		//}
		$rows[] = array(
			'data' => array(
				array('data' => $current_rank, 'class' => array('text-right')),
				$player_name_cell,
				array('data' => $player->correct, 'class' => array('text-right')),
				array('data' => $player->incorrect, 'class' => array('text-right')),
				array('data' => number_format($pct, 3), 'class' => array('text-right')),
				#$data['num_picks'],
				array('data' => isset($player->pick_count) ? $player->pick_count : '', 'class' => array('text-right')),
			),
			'class' => $classes,
		);
	}
	$build = array(
		'#theme' => 'table',
		'#header' => $headers,
		'#rows' => $rows,
		'#attributes' => array('class' => array('table', 'table-condensed', 'standings')),
	);
	return array(
		'subject' => t('Leaderboard'),
		'content' => $build,
	);
}

function pickem_user_delete($account) {
	db_delete('pick')
		->condition('uid', $account->uid)
		->execute();
}

function pickem_user_register_action($object, $context) {
	# object = user
	// add the 'pickem' role to the newly created user so he/she can make picks
	
	#$role = user_role_load_by_name('pickem');
	#user_multiple_role_edit(array($object->uid), 'add_role', $role->rid);
}

function pickem_ajax_load_slate_stats($uid = NULL) {
	if ($uid == NULL || $uid == 1) {
		$uid = 12;
	}
	$data = pickem_load_pick_data(-1, variable_get('pickem.current_season'), array('uid' => $uid));
	$return = array_shift($data['player']);
	return drupal_json_output(array('player' => $return));
}

function pickem_accproj_lookup($form, &$form_state) {
	$form_state['game_keys'] = array();
	
	$query = db_select('game', 'g')
		->fields('g', array('gid', 'visiting_school_name', 'host_school_name'))
		->condition('completed', 'N');
	$query->join('school', 'visiting', 'g.visiting_school_name = visiting.name');
	$query->join('school', 'host', 'g.host_school_name = host.name');
	$query->addField('host', 'displaytitle', 'host_school');
	$query->addField('visiting', 'displaytitle', 'visiting_school');
	$query->condition('gid', array(24, 40, 56, 72, 79, 80, 96, 104, 111));
	$query->orderBy('game_date');
	$result = $query->execute();
	
	$last_form_key = NULL;
	$form['games_of_interest'] = array(
		'#type' => 'fieldset',
		'#title' => t('Games of Interest'),
		'#collapsible' => TRUE,
		'#collapsed' => FALSE,
		'#attributes' => array('class' => array('well')),
	);
	foreach ($result as $ikey => $game) {
		$options = array();
		$key = sprintf("%s over %s", $game->visiting_school_name, $game->host_school_name);
		$options[$key] = t(sprintf("%s over %s", $game->visiting_school, $game->host_school));
		$key = sprintf("%s over %s", $game->host_school_name, $game->visiting_school_name);
		$options[$key] = t(sprintf("%s over %s", $game->host_school, $game->visiting_school));
		
		$form_key = sprintf("%s_%s", $game->visiting_school_name, $game->host_school_name);
		$title = sprintf("%s at %s", $game->visiting_school, $game->host_school);
		$form['games_of_interest'][$form_key] = array(
			'#type' => 'select',
			'#options' => $options,
			'#title' => t($title),
			'#default_value' => isset($form_state['values'][$form_key]) ? $form_state['values'][$form_key] : '',
			'#empty_value' =>'',
			'#empty_option' => t('-- Select Outcome --'),
			//'#prefix' => '<div class="control-group' . (isset($form_state['values'][$form_key]) ? ' success' : '') . '">',
			//'#suffix' => '</div>',
		);

		$form_state['game_keys'][] = $form_key;
		$last_form_key = $form_key;
	}

	//$form['divider'] = array(
	//	'#type' => 'markup',
	//	'#markup' => '<hr class="clearfix" />',
	//);
	$options = array(
		'duke' => t('Duke'),
		'georgiatech' => t('Georgia Tech'),
		'miami' => t('Miami'),
		'vatech' => t('Virginia Tech')
	);
	
	$form['winner'] = array(
		'#type' => 'select',
		'#options' => $options,
		'#default_value' => isset($form_state['values']['winner']) ? $form_state['values']['winner'] : '',
		'#empty_value' =>'',
		'#empty_option' => t('-- Select Winner --'),
		'#title' => t('Winner'),
	);
	$form['divider2'] = array(
		'#type' => 'markup',
		'#markup' => '<hr class="clearfix" />',
	);
	$form['search'] = array(
		'#type' => 'submit',
		'#value' => t('Search Results...'),
		'#prefix' => '<div class="clearfix" style="margin-bottom: 1em;">',
		'#suffix' => '</div>',
	);
	if (isset($form_state['results'])) {
		// create a table
		$header = array(
			t('School'),
			t('# Outcomes as Champion<br /><small>Out of :valid_outcomes outcomes</small>', array(':valid_outcomes' => $form_state['valid_outcomes'])),
			t('Tiebreaker Methods'),
		);
		$rows = array();
		if (!empty($form_state['results'])) {
			foreach ($form_state['results'] as $school_name => $data) {
				$row = array();
				$row[] = array(
					'data' => '<img src="/sites/all/modules/pickem/logos/ncaaf/' . $school_name . '.gif" width="50">',
					'class' => array('text-center')
				);
				$row[] = $data['champ'];
				$how = array();
				foreach ($data['how'] as $hkey => $hdata) {
					$hkey = join(', ', explode(',', $hkey));
					//$how[] = l(sprintf("%s - %s", $hkey, $hdata), 'scene_details/' . $school_name . '/' . $hkey);
					$how[] = sprintf("%s - %s", $hkey, $hdata);
				}
				$row[] = join('<br />', $how);
				$rows[] = $row;
			}
		}
		$form['outcomes'] = array(
			'#theme' => 'table',
			'#attributes' => array(
				'class' => array('table', 'table-bordered', 'table-hover'),
			),
			'#header' => $header,
			'#rows' => $rows,
			'#empty' => t("Your selected winner has likely been eliminated from contention."),
		);
	}
	return $form;
}

function projection_lookup_cmp($a, $b) {
	if ($a['champ'] == $b['champ']) {
		return $a['school_name'] < $b['school_name'] ? -1 : 1;
	}
	return $a['champ'] > $b['champ'] ? -1 : 1;
}

function pickem_accproj_lookup_submit($form, &$form_state) {
	$outcomes = array();
	foreach ($form_state['game_keys'] as $game_key) {
		if ($form_state['values'][$game_key] != '') {
			$outcomes[] = $form_state['values'][$game_key];
		}
	}

	if (empty($outcomes)) {
		return;
	}

	$sql = 'SELECT o.* FROM {outcome_scenario} o ';
	if (!empty($outcomes)) {
		$sql .= 'WHERE (';
		foreach ($outcomes as $ndx => $outcome) {
			$sql .= ($ndx == count($outcomes) - 1) 
				? "scene_text LIKE '%" . $outcome . "%' "
				: "scene_text LIKE '%" . $outcome . "%' AND ";
		}
		$sql .= ') ';
	}
	if (!empty($form_state['values']['winner'])) {
		$sql .= "AND winner = '" . $form_state['values']['winner'] . "'";
	}

	$result = db_query($sql);
	$form_state['results'] = array();
	
	$winners = array();
	$count = 0;
	foreach ($result as $row) {
		$count++;
		if (!isset($winners[$row->winner])) {
			$winners[$row->winner] = array(
				'school_name' => $row->winner,
				'champ' => 0,
				'how' => array()
			);
		}
		$winners[$row->winner]['champ']++;
		if (!isset($winners[$row->winner]['how'][$row->how])) {
			$winners[$row->winner]['how'][$row->how] = 0;
		}
		$winners[$row->winner]['how'][$row->how]++;
	}
	uasort($winners, 'projection_lookup_cmp');
	
	$form_state['results'] = $winners;
	$form_state['valid_outcomes'] = $count;
	
	$form_state['rebuild'] = TRUE;
}

// ================== UTILITY FUNCTION(S) ==================
/**
 * Clear the session 'pick' cache for the user id ($uid)
 */
function _pickem_clear_cache($uid=NULL) {
	if (is_null($uid)) {
		global $user;
		$uid = $user->uid;
	}
	$cache_key = sprintf('picks.%s', $uid);
	cache_clear_all('picks*', 'cache', TRUE);	
}
function _pickem_cache_pick($pickem, $slid, $week, $objid, $objtype, $pkid, $target_team_name) {
	global $user;
	
	// CACHE DATA
	$cache_key = sprintf('picks.%s', $user->uid);
	$cache_picks = array();
	if ($cache = cache_get($cache_key)) {
		$cache_picks = $cache->data;
	}

	if (isset($cache_picks)) {
		if ($pkid == 'new') {
			if (isset($cache_picks['new'][$objid])) {
				if ($cache_picks['new'][$objid]->pick_team_name == $target_team_name) {
					// uncheck or clear the pick if it's the one already selected
					unset($cache_picks['new'][$objid]);
					
					// clear the target school so the button state will reset.
					$target_team_name = NULL;
				}
				else {
					$cache_picks[$pkid][$objid]->pick_team_name = $target_team_name;
				}
			}
			else {
				// this is to handle the "NEW" picks that 
				// never were in the database
				//
				// create an array of new picks, one for each event (game, series or tourney)
				$o = entity_create('pick', array('type' => 'pick'));
				$o->slid = $slid;
				$o->uid = $user->uid;
				$o->pick_team_name = $target_team_name;
				$o->correct = NULL;
				$cache_picks['new'][$objid] = $o;
			}
		}
		else {
			// change for a pick previously saved to database
			if (isset($cache_picks[$pkid]) && $cache_picks[$pkid] == $target_team_name) {
				// clear it.
				$cache_picks[$pkid] = '';
			}
			else {
				$cache_picks[$pkid] = $target_team_name;
			}
		}
		watchdog('pickem', print_r($cache_picks, TRUE));
		cache_set($cache_key, $cache_picks, 'cache');
	}
	
}
// ================== ENTITY FUNCTIONS =====================

//// ---- LABEL CALLBACKS -----
/**
 * Label callback for team entities
 */
function pickem_label_callback($pickem, $type = NULL) {
	return empty($pickem->name) ? 'Untitled Pickem' : $pickem->title;	
}

/**
 * Label callback for Slate entities
 */
function pickem_slate_label_callback($slate, $type) {
	// @TODO get parent pickem object
	return sprintf('Pickem Slate, Season %s - Week %s', $slate->season, $slate->week);
}

/// --- URI CALLBACKS ----
/**
 * URI Callback for PickemSlate
 */
function pickem_slate_basic_uri($pickem_slate) {
	return array(
		'path' => 'pickem/slate/' . $pickem_slate->slid,
	);
}

/// ------ CRUD CALLBACKS & FUNCTIONS ----------

/**
 * Autoload callback
 */
function pickem_load($pickem_id, $reset=FALSE) {
  $pickem = pickem_load_multiple(array($pickem_id), array(), $reset);
  return reset($pickem);
}

/**
 * Load multiple pickems based on certain conditions.
 */
function pickem_load_multiple($pickem_ids = FALSE, $conditions = array('active' => 1), $reset = FALSE) {
  return entity_load('pickem', $pickem_ids, $conditions, $reset);
}

/**
 * Load pickem by name
 */
function pickem_load_by_name($pname, $reset=FALSE) {
	$pickems = pickem_load_multiple(FALSE, array('name' => $pname), $reset);
	return reset($pickems);
}

/**
 * Deletes a Pickem.
 */
function pickem_delete(Pickem $pickem) {
  $pickem->delete();
}

/**
 * Delete multiple pickems.
 */
function pickem_delete_multiple(array $pickem_ids) {
  entity_get_controller('pickem')->delete($pickem_ids);
}

// pickem slates

/**
 * Autoload callback
 */
function pickem_slate_load($slate_id, $reset=FALSE) {
  $pickem_slate = pickem_slate_load_multiple(array($slate_id), array(), $reset);
  return reset($pickem_slate);
}

/**
 * Load multiple pickem slates based on certain conditions.
 */
function pickem_slate_load_multiple($slate_ids = FALSE, $conditions = array(), $reset = FALSE) {
  return entity_load('pickem_slate', $slate_ids, $conditions, $reset);
}


/**
 * Deletes a Pickem Slate.
 */
function pickem_slate_delete(PickemSlate $pickem_slate) {
  $pickem_slate->delete();
}

/**
 * Delete multiple pickem slates.
 */
function pickem_slate_delete_multiple(array $slate_ids) {
  entity_get_controller('pickem_slate')->delete($slate_ids);
}

// pick

/**
 * Autoload callback
 */
function pick_load($pick_id, $reset=FALSE) {
  $pick = pick_load_multiple(array($pick_id), array(), $reset);
  return reset($pick);
}

/**
 * Load multiple games based on certain conditions.
 */
function pick_load_multiple($pick_ids = FALSE, $conditions = array('active' => 1), $reset = FALSE) {
  return entity_load('pick', $pick_ids, $conditions, $reset);
}

/**
 * Deletes a Game.
 */
function pick_delete(Pick $pick) {
  $pick->delete();
}

/**
 * Delete multiple games.
 */
function pick_delete_multiple(array $pick_ids) {
  entity_get_controller('pick')->delete($pick_ids);
}

// pickem player

/**
 * Autoload callback
 */
function pickem_player_load($uid, $reset=FALSE) {
  $pickem_player = pickem_player_load_multiple(array($uid), array(), $reset);
  return reset($pickem_player);
}

/**
 * Load multiple pickem players based on certain conditions.
 */
function pickem_player_load_multiple($uids = FALSE, $conditions = array(), $reset = FALSE) {
  return entity_load('pickem_player', $uids, $conditions, $reset);
}

/**
 * Deletes a Pickem Player.
 */
function pickem_player_delete(PickemPlayer $pickem_player) {
  $pickem_player->delete();
}

/**
 * Delete multiple pickem players.
 */
function pickem_player_delete_multiple(array $uids) {
  entity_get_controller('pickem_player')->delete($uids);
}
